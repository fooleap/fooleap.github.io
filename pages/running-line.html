---
layout : null
permalink: /running-line.html
title: 跑步线路
---
<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <title>{{ page.title }}</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0,maximum-scale=1.3, user-scalable=no" />
        <meta name="description" content="A foolish man could not always lose!" />
        <meta name="keywords" content="fooleap, 前端, Linux, 潮汕" />
        <meta name="author" content="fooleap" />
        <meta name="renderer" content="webkit">
        <style>
            html,body, #map{
                margin: 0;
                width: 100%;
                height: 100%;
            }
            #map .marker-circle{
                width: 9px;
                height: 9px;
                border: 3px solid #fff;
                border-radius: 99em;
                box-shadow: 1px 1px 0 rgba(0,0,0,.4);
            }
            #map .marker-circle.green{
                background-color: #60AB43;
            }
            #map .marker-circle.red{
                background-color: #f80000;
            }
            #map .marker-circle.black{
                background-color: #000000;
            }
            #map .running-distance{
                background-color: #000;
                font-size: 10px;
                font-family: 'AlternateBoldFont', 'MHei PRC Bold';
                color: #fff;
                width: 45px;
                height: 24px;
                line-height: 24px;
                text-align: right;
                border-top-left-radius: 12px;
                border-bottom-left-radius: 12px;
                position: relative;
                white-space: nowrap;
            }
            #map .running-distance:after{
                content: "";
                right: -24px;
                top: 0;
                position: absolute;
                height: 0;
                width: 0;
                border: 12px solid transparent;
                border-left-color: #000;
            }
            #map .running-distance .running-number{
                color: #83DD00;
            }
        </style>
    </head>
    <body>

        <div id="map"></div>

        <script src="http://webapi.amap.com/maps?v=1.3&key=29076a35fd5abd25add2eb561488a73f"></script>
        <script src="/assets/js/coordtransform.js"></script>
        <script>
            function getQueryVariable(variable) {
                var query = window.location.search.substring(1);
                var vars = query.split("&");
                for (var i=0;i<vars.length;i++) {
                    var pair = vars[i].split("=");
                    if(pair[0] == variable){return pair[1];}
                }
                return(false);
            }
            var nikeid = getQueryVariable('nikeid');
var lineArr = [];
var xhr = new XMLHttpRequest();
xhr.open('GET', 'http://api.fooleap.org/nike/activity?id='+ nikeid, true);
xhr.onreadystatechange = function() {
    if (xhr.readyState == 4 && xhr.status == 200) {
        var data = JSON.parse(xhr.responseText);
        for( var i = 0; i < data.length; i++){
            lineArr[i] = coordtransform.wgs84togcj02(data[i].lng,data[i].lat);
        }
        showMap(lineArr);
    }
}
xhr.send();
function showMap(lineArr){
    var map = new AMap.Map('map');
    var lineArray = [];
    var distance = 0;
    var hundredpoints = [0];
    var num = 1;
    for (var i = 0; i < lineArr.length - 1; i++) {
        var point = new AMap.LngLat(lineArr[i][0], lineArr[i][1]);
        distance += point.distance(lineArr[i + 1]);
        if (distance > 100 * num) {
            num += 1;
            hundredpoints.push(i + 1);
        }
    }
    hundredpoints.push(lineArr.length-1);
    for (var i = 0; i < hundredpoints.length - 1; i++) {
        lineArray[i] = [];
        for (var e = hundredpoints[i]; e <= hundredpoints[i + 1]; e++) {
            lineArray[i].push(lineArr[e]);
        }
    }
    var marker1 = new AMap.Marker({
        position: lineArr[0],
        zIndex: 11,
        offset: new AMap.Pixel(-8, -8),
        content: '<div class="marker-circle green"></div>'
    });
    marker1.setMap(map);
    var marker2 = new AMap.Marker({
        position: lineArr[lineArr.length - 1],
        zIndex: 11,
        offset: new AMap.Pixel(-8, -8),
        content: '<div class="marker-circle red"></div>'
    });
    marker2.setMap(map);
    var marker3 = new AMap.Marker({
        position: lineArr[lineArr.length - 1],
        zIndex: 10,
        offset: new AMap.Pixel(-64, -12),
        content: '<div class="running-distance"><span class="running-number">' + (distance/1000).toFixed(1) + '</span>公里</div>'
    });
    marker3.setMap(map);
    var marker = new AMap.Marker({
        zIndex: 12,
        offset: new AMap.Pixel(-8, -8),
        content: '<div class="marker-circle black"></div>'
    });
    var polyline = new AMap.Polyline({
        map: map,
        path: lineArr,
        strokeColor: "#52EE06",
        strokeOpacity: 1,
        strokeWeight: 3,
        strokeStyle: "solid"
    });
    var runPolyline = new AMap.Polyline({
        map: map,
        strokeColor: "#52EE06",
        strokeOpacity: 1,
        strokeWeight: 3,
        strokeStyle: "solid",
    });
    runPolyline.setMap(map);
    var i = 0;
    var polylineLength = 0;
    var line = [];
    function drawline() {
        if (i < lineArray.length) {
            line = line.concat(lineArray[i]);
            runPolyline.setPath(line);
            marker.setPosition(lineArray[i][lineArray[i].length - 1]);
            //有错误
            //path = runPolyline.getLength();
            path = (i * 0.1).toFixed(1);
            marker3.setContent('<div class="running-distance"><span class="running-number">' + path + '</span>公里</div>');
            i++;
        } else {
            marker.hide();
            return;
        }
        setTimeout(drawline, 50)
    }
    map.setFitView();
    map.on('click', function() {
        polyline.setOptions({
            strokeColor: "#000000",
            strokeOpacity: 0.2
        });
        marker.setMap(map);
        drawline();
    });
}
        </script>
    </body>
</html>
